<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>ttshangxiang</title>
    <style>
        #user-table {
            border-collapse: collapse;
        }
        
        #user-table td,
        #user-table th {
            line-height: 27px;
            padding: 0 12px;
            border: 1px solid #ccc;
        }
        
        .box {
            padding: 12px;
        }
        
        input {
            margin-bottom: 2px;
        }

        .input-box label {
            width: 88px;
            display: inline-block;
        }
    </style>
</head>

<body>
    <div class="box">
        <select name="" id="type">
            <option value="users">users</option>
            <option value="words">words</option>
        </select>
        <input type="button" value="全部" onclick="findAll()">
        <input type="button" value="查询" onclick="findUser()">
    </div>
    <form class="box" id="my-form" name="my-form">
        <span id="error"></span>
        <div class="input-box">
        </div>
        <input type="button" value="新增" onclick="addUser()">
        <input type="button" value="修改" onclick="updateUser()">
        <input type="button" value="删除" onclick="deleteUser()">
        <input type="reset" value="重置">
    </form>
    <div class="user-list">
        <table id="user-table">
        </table>
    </div>
    <script src="http://apps.bdimg.com/libs/jquery/1.8.3/jquery.min.js"></script>
    <script>
        // 获取表单
        var getForm = function() {
            var obj = {};
            $('#my-form input[type=text]').each(function(index, el){
                obj[$(el).attr('name')] = $(el).val();
            })
            return obj;
        }

        // 设置表单
        var setForm = function(obj) {
            for(var i in obj) {
                $('#my-form input[name="'+i+'"]').val(obj[i]);
            }
        }

        // 创建表单
        var createForm = function(el) {
            var str = '';
            for(var i in el) {
                str += '<label>'+i+'</label><input type="text" name="'+i+'"><br>';
            }
            $('#my-form .input-box').html(str);
        }

        // 创建表格
        var createTable = function(data) {
            var str = '';
            $.each(data, function(index, el) {
                str += '<tr>';
                for(var i in el) {
                    str += '<td data="'+i+'">'+( el[i] || '' )+'</td>';
                }
                str += '</tr>';
            });
            $('#user-table').html(str);
        }

        // 检查数据
        var validate = function(obj, type) {
            var count = 0;
            var pass = 0;
            for(var i in obj) {
                if (i == '_id') { 
                    continue;
                }
                count++;
                obj[i] != '' && pass++;
            }
            if (type == 'all') {
                return count == pass;
            }
            if (type == 'one') {
                return pass > 0;
            }
        }

        // 清除空
        var clearNull = function(obj) {
            for(var i in obj) {
                if (obj[i] == '') {
                    obj[i] = undefined;
                }
            }
            return obj;
        }

        // 查询所有
        var findAll = function() {
            $('#user-table').html('');
            $.ajax({
                    url: '/api/'+$('#type').val()
                })
                .done(function(data) {
                    createForm(data[0]);
                    createTable(data);
                })
                .fail(function() {
                    console.log("error");
                    $('#error').html(data.message);
                })
        }

        // 条件查询
        var findUser = function() {
            let formData = getForm();
            $('#user-table').html('');
            if (!formData.name) {
                formData.name = undefined;
            }
            if (!formData.username) {
                formData.username = undefined;
            }
            if (!formData.password) {
                formData.password = undefined;
            }
            if (!formData._id) {
                formData._id = undefined;
            }
            $.ajax({
                    url: '/api/'+$('#type').val()+'/query',
                    type: 'get',
                    data: formData
                })
                .done(function(data) {
                    createForm(data[0]);
                    createTable(data);
                })
                .fail(function() {
                    console.log("error");
                    $('#error').html(data.message);
                })
        }

        // 添加
        var addUser = function() {
            let formData = getForm();

            if (formData._id) {
                $('#error').html('_id不需要，请置空');
                return;
            }
            formData._id = undefined;
            if (!validate(formData,'all')) {
                $('#error').html('除了_id其他必填项');
                return;
            }
            $('#error').html('');
            $.ajax({
                    url: '/api/'+$('#type').val(),
                    type: 'post',
                    data: formData
                })
                .done(function(data) {
                    if (data.status) {
                        findAll()
                    } else {
                        $('#error').html(data.message);
                    }
                })
                .fail(function() {
                    console.log("error");
                })
        }

        // 修改
        var updateUser = function() {
            let formData = getForm();

            if (!formData._id) {
                $('#error').html('_id必填');
                return;
            }
            if (!validate(formData,'one')) {
                $('#error').html('必须改变点什么，不然没必要修改');
                return;
            }
            formData = clearNull(formData);
            $('#error').html('');
            $.ajax({
                    url: '/api/'+$('#type').val(),
                    type: 'put',
                    data: formData
                })
                .done(function(data) {
                    if (data.status) {
                        findAll()
                    } else {
                        $('#error').html(data.message);
                    }
                })
                .fail(function() {
                    console.log("error");
                })
        }

        // 删除
        var deleteUser = function() {

            let _id = $('input[name=_id]').val();
            if (!_id) {
                $('#error').html('_id必填');
                return;
            }
            $('#error').html('');
            $.ajax({
                    url: '/api/'+$('#type').val()+'/' + _id,
                    type: 'delete'
                })
                .done(function(data) {
                    if (data.status) {
                        findAll();
                    } else {
                        $('#error').html(data.message);
                    }
                })
                .fail(function() {
                    console.log("error");
                })
        }

        // 点击选中
        $('#user-table').on('click', 'tr', function(event) {
            var obj = {};
            $(this).find('td').each(function(index, el) {
                obj[$(el).attr('data')] = $(el).text();
            })
            setForm(obj);
        })
    </script>
</body>

</html>